<!DOCTYPE html>
<html>
<head>
<title>Tile Production Configurator</title>

<style>
body{
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
  background:#f7f7f7;
  margin:0;
  padding:50px;
  color:#111;
}

.container{max-width:1100px;margin:auto;}
h1{font-size:24px;font-weight:600;margin-bottom:5px;}
.subtitle{color:#666;margin-bottom:40px;font-size:14px;}

.section{
  background:#fff;
  padding:30px;
  border-radius:10px;
  margin-bottom:30px;
  border:1px solid #e5e5e5;
}

label{font-size:13px;font-weight:600;margin-bottom:6px;display:block;}
input,select{
  width:100%;padding:10px;border:1px solid #ddd;
  border-radius:6px;font-size:14px;background:#fff;
}

.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:20px;
}

.palette-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
  gap:15px;margin-top:10px;
}

.palette{
  border:1px solid #ddd;
  border-radius:8px;
  padding:10px;
  cursor:pointer;
  transition:.2s;
}
.palette:hover{border-color:#111;}
.palette.active{border:2px solid #111;}

.color-row{display:flex;gap:5px;margin-top:8px;}
.color{width:20px;height:20px;border-radius:4px;border:1px solid #ccc;}

button{
  background:#111;color:white;
  padding:12px 20px;border:none;
  border-radius:6px;cursor:pointer;
  font-size:14px;margin-top:20px;
}
button:hover{opacity:.9;}

.summary{font-size:14px;line-height:1.8;}

.result{text-align:center;}

canvas{
  max-width:600px;
  margin-top:20px;
  border-radius:8px;
  border:1px solid #ddd;
}

.control-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
  gap:20px;
  margin-top:20px;
}
</style>
</head>

<body>
<div class="container">

<h1>Tile Production Configurator</h1>
<p class="subtitle">Factory-ready tile specification system</p>
<div id="roomRefContainer" class="section" style="display: none; align-items: center; gap: 20px;">
    <img id="roomMiniPreview" src="" style="width: 120px; height: 80px; object-fit: cover; border-radius: 8px; border: 2px solid #007bff;">
    <div>
        <h3 style="margin:0; font-size: 16px; color: #0a3c80;">Selected Room</h3>
        <p style="margin:0; font-size: 12px; color: #666;">‡∏†‡∏≤‡∏û‡∏´‡πâ‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏π‡∏û‡∏∑‡πâ‡∏ô‡∏à‡∏£‡∏¥‡∏á</p>
    </div>
</div>
<div class="section">

<label>Pattern Description</label>
<input type="text" id="prompt" placeholder="White marble with subtle gold veins">

<br><br>

<div class="grid">

<div>
<label>Tile Size</label>
<select id="tileSize"></select>
</div>

<div>
<label>DPI</label>
<select id="dpi">
<option value="150">150 DPI</option>
<option value="300" selected>300 DPI</option>
<option value="600">600 DPI</option>
</select>
</div>

<div>
<label>Seamless Type</label>
<select id="patternType">
<option value="grid">Grid</option>
<option value="halfdrop">Half Drop</option>
<option value="mirror">Mirror</option>
</select>
</div>

</div>

<br>

<label>Factory Color Palette</label>
<div id="paletteContainer" class="palette-grid"></div>



<div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:20px;">
  <button onclick="generateTile()" style="margin-top:0">Generate Tile</button>
  <button onclick="document.getElementById('tileUploadInput').click()" style="margin-top:0;background:#444;">
    üìÅ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏•‡∏≤‡∏¢‡∏Å‡∏£‡∏∞‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á
  </button>
  <input type="file" id="tileUploadInput" accept="image/png,image/jpeg" hidden>
  <span id="tileUploadName" style="font-size:13px;color:#888;"></span>
</div>

</div>

<div class="section summary">
<p><strong>Price per Tile:</strong> <span id="pricePerTile">0</span> THB</p>
<p><strong>Minimum Production (100 sqm):</strong> <span id="minTiles">0</span> Tiles</p>
<p><strong>Total Estimated Cost:</strong> <span id="totalCost">0</span> THB</p>
</div>

<div class="section result">
<p id="status">Ready</p>
<canvas id="tileCanvas" width="600" height="600"></canvas>


<div class="control-grid">
<div>
<label>Grout Width</label>
<input type="range" id="groutWidth" min="0" max="15" value="4">
</div>

<div>
<label>Grout Color</label>
<input type="color" id="groutColor" value="#dddddd">
</div>

<div>
<label>Zoom</label>
<input type="range" id="zoomControl" min="0.5" max="2" step="0.1" value="1">
</div>
</div>
<button onclick="goToPreview()" style="background:#007bff; margin-left: 10px;">View Room Preview</button>
</div>

</div>

<script>

/* ================= AUTH & INITIAL DATA ================= */
const user = JSON.parse(localStorage.getItem("user"));
if (!user) { 
    alert("Login required"); 
    window.location.href = "login.html"; 
}

const roomImageUrl = localStorage.getItem("roomImage");

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏£‡∏π‡∏õ‡∏´‡πâ‡∏≠‡∏á‡∏°‡∏≤‡πÇ‡∏ä‡∏ß‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
window.addEventListener('DOMContentLoaded', () => {
    if (roomImageUrl) {
        const container = document.getElementById("roomRefContainer");
        const miniPreview = document.getElementById("roomMiniPreview");
        if (container && miniPreview) {
            container.style.display = "flex"; // ‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
            miniPreview.src = roomImageUrl;
            console.log("‚úÖ Room image loaded:", roomImageUrl);
        }
    }
});

/* ================= VARIABLES ================= */
let basePrices={};
let selectedPalette=null;
let currentTexture=null;

let groutWidth=4;
let groutColor="#dddddd";
let zoom=1;

let areaPerTile={
 "30x30":0.09,
 "60x60":0.36,
 "60x120":0.72,
 "80x80":0.64
};

const canvas=document.getElementById("tileCanvas");
const ctx=canvas.getContext("2d");

/* ================= FACTORY CONFIG ================= */
async function loadFactoryConfig(){
 try{
  const res=await fetch("/factory-config");
  const data=await res.json();
  basePrices=data.sizes;
  createSizeOptions();
  createPalettes(data.palettes);
 }catch{
  basePrices={
   "30x30":70,
   "60x60":120,
   "60x120":220,
   "80x80":180
  };
  createSizeOptions();
  createPalettes([
   {name:"Mono Series",colors:["#fff","#d9d9d9","#bfbfbf"],multiplier:1},
   {name:"Luxury Marble",colors:["#fff","#f2f2f2","#d4af37","#444"],multiplier:1.25}
  ]);
 }
 updateSummary();
 restoreTexture();
}

function createSizeOptions(){
 const select=document.getElementById("tileSize");
 select.innerHTML="";
 Object.keys(basePrices).forEach(size=>{
  const opt=document.createElement("option");
  opt.value=size;
  opt.textContent=size+" cm";
  if(size==="60x60") opt.selected=true;
  select.appendChild(opt);
 });
}

function createPalettes(palettes){
 const container=document.getElementById("paletteContainer");
 container.innerHTML="";
 palettes.forEach((palette,index)=>{
  const div=document.createElement("div");
  div.className="palette";
  div.innerHTML="<strong>"+palette.name+"</strong>";
  const row=document.createElement("div");
  row.className="color-row";
  palette.colors.forEach(c=>{
   const color=document.createElement("div");
   color.className="color";
   color.style.background=c;
   row.appendChild(color);
  });
  div.appendChild(row);
  div.onclick=()=>{
   document.querySelectorAll(".palette").forEach(p=>p.classList.remove("active"));
   div.classList.add("active");
   selectedPalette=palette;
   updateSummary();
  };
  if(index===0){
   div.classList.add("active");
   selectedPalette=palette;
  }
  container.appendChild(div);
 });
}

/* ================= PRICE ================= */
function calculatePrice(){
 let base=basePrices[tileSize.value]||0;
 let multiplier=selectedPalette?.multiplier||1;
 if(document.getElementById("dpi").value==="600") base*=1.2;
 return Math.round(base*multiplier);
}

function calculateProduction(){
 return Math.ceil(100/areaPerTile[tileSize.value]);
}

function updateSummary(){
 let price=calculatePrice();
 let minTiles=calculateProduction();
 document.getElementById("pricePerTile").innerText=price;
 document.getElementById("minTiles").innerText=minTiles;
 document.getElementById("totalCost").innerText=price*minTiles;
}

/* ================= PATTERN ENGINE ================= */
function loadTexture(url){
 const img=new Image();
 img.crossOrigin="anonymous";
 img.onload=function(){
  currentTexture=img;
  localStorage.setItem("lastTexture",url);
  renderPattern();
 };
 img.src=url;
}

function renderPattern(){
 if(!currentTexture) return;

 ctx.clearRect(0,0,canvas.width,canvas.height);

 let tilePixel=200;
 if(tileSize.value==="30x30") tilePixel=120;
 if(tileSize.value==="60x60") tilePixel=200;
 if(tileSize.value==="60x120") tilePixel=280;
 if(tileSize.value==="80x80") tilePixel=240;

 tilePixel*=zoom;

 for(let y=0;y<canvas.height;y+=tilePixel+groutWidth){
  for(let x=0;x<canvas.width;x+=tilePixel+groutWidth){

   let offsetX=x;
   let offsetY=y;

   if(patternType.value==="halfdrop" && Math.floor(y/(tilePixel+groutWidth))%2===1){
     offsetX+=tilePixel/2;
   }

   if(patternType.value==="mirror" && Math.floor(x/(tilePixel+groutWidth))%2===1){
     ctx.save();
     ctx.scale(-1,1);
     ctx.drawImage(currentTexture,-offsetX-tilePixel,offsetY,tilePixel,tilePixel);
     ctx.restore();
   }else{
     ctx.drawImage(currentTexture,offsetX,offsetY,tilePixel,tilePixel);
   }

   ctx.fillStyle=groutColor;
   ctx.fillRect(offsetX+tilePixel,offsetY,groutWidth,tilePixel);
   ctx.fillRect(offsetX,offsetY+tilePixel,tilePixel+groutWidth,groutWidth);
  }
 }
}

/* ================= GENERATE ================= */
async function generateTile(){
 const prompt=document.getElementById("prompt").value.trim();
 if(!prompt){alert("Enter description");return;}

 document.getElementById("status").innerText="Generating...";

 const response=await fetch("/generate-tile",{
  method:"POST",
  headers:{"Content-Type":"application/json"},
  body:JSON.stringify({
   prompt,
   tileSize:tileSize.value,
   dpi:dpi.value,
   palette:selectedPalette,
   pattern:patternType.value,
   pricePerTile:calculatePrice(),
   minTiles:calculateProduction(),
   userId:user.id
  })
 });

 const data=await response.json();
 if(!data.tileUrl){alert("Generation failed");return;}

 loadTexture(window.location.origin+data.tileUrl);
 document.getElementById("status").innerText="Success";
}

/* ================= TILE UPLOAD ================= */
document.getElementById('tileUploadInput').addEventListener('change', function(){
  const file = this.files[0];
  if(!file) return;
  if(!["image/jpeg","image/png"].includes(file.type)){
    alert("‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞ JPG ‡πÅ‡∏•‡∏∞ PNG");
    return;
  }
  const reader = new FileReader();
  reader.onload = function(e){
    const dataUrl = e.target.result;
    loadTexture(dataUrl);
    document.getElementById("status").innerText = "‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + file.name;
    document.getElementById("tileUploadName").textContent = file.name;
  };
  reader.readAsDataURL(file);
});

/* ================= RESTORE ================= */
function restoreTexture(){
 const saved=localStorage.getItem("lastTexture");
 if(saved){
  loadTexture(saved);
  document.getElementById("status").innerText="Restored from session";
 }
}

/* ================= EVENTS ================= */
tileSize.onchange=renderPattern;
patternType.onchange=renderPattern;
document.getElementById("groutWidth").oninput=e=>{
 groutWidth=parseInt(e.target.value);
 renderPattern();
};
document.getElementById("groutColor").oninput=e=>{
 groutColor=e.target.value;
 renderPattern();
};
document.getElementById("zoomControl").oninput=e=>{
 zoom=parseFloat(e.target.value);
 renderPattern();
};

document.getElementById("tileSize").addEventListener("change",updateSummary);
document.getElementById("dpi").addEventListener("change",updateSummary);

loadFactoryConfig();

/* ================= NAVIGATION ================= */
function goToPreview() {
    const savedTexture = localStorage.getItem("lastTexture");
    if(!savedTexture && !currentTexture) {
        alert("Please generate a tile first!");
        return;
    }
    // ‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏ä‡∏∑‡πà‡∏≠ preview.html ‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß
    window.location.href = "preview.html";
}

</script>
</body>
</html>