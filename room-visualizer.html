<!DOCTYPE html>
<html>
<head>
<title>Room Visualizer</title>

<style>
body{
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
  background:#f5f5f5;
  margin:0;
  padding:40px;
  color:#111;
}

.container{max-width:1200px;margin:auto;}

h1{font-size:22px;margin-bottom:10px;}
.subtitle{color:#666;font-size:14px;margin-bottom:30px;}

.section{
  background:#fff;
  padding:25px;
  border-radius:10px;
  border:1px solid #e5e5e5;
  margin-bottom:25px;
}

.controls{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
  gap:20px;
}

label{font-size:13px;font-weight:600;margin-bottom:5px;display:block;}

input[type="range"],input[type="file"]{
  width:100%;
}

button{
  padding:10px 18px;
  background:#111;
  color:#fff;
  border:none;
  border-radius:6px;
  cursor:pointer;
  margin-top:15px;
}

button.secondary{
  background:#555;
}

canvas{
  max-width:100%;
  border-radius:8px;
  border:1px solid #ddd;
}
</style>
</head>

<body>
<div class="container">

<h1>Room Visualizer</h1>
<p class="subtitle">AI Floor Segmentation + Tile Placement</p>

<div class="section">
<label>Upload Room Image</label>
<input type="file" id="roomUpload" accept="image/*">
</div>

<div class="section controls">
<div>
<label>Tile Scale</label>
<input type="range" id="tileScale" min="0.3" max="2" step="0.1" value="1">
</div>

<div>
<label>Tile Opacity</label>
<input type="range" id="tileOpacity" min="0.3" max="1" step="0.05" value="0.85">
</div>

<div>
<label>Lighting Adjust</label>
<input type="range" id="brightness" min="0.6" max="1.4" step="0.05" value="1">
</div>
</div>

<div class="section">
<canvas id="roomCanvas"></canvas>
</div>

<button onclick="saveProject()">Save Project</button>
<button class="secondary" onclick="goBack()">Back to Configurator</button>

</div>

<script>

/* ================= LOAD CONFIG ================= */
const config = JSON.parse(localStorage.getItem("activeTileConfig"));
if(!config){
 alert("No tile selected");
 window.location.href="configurator.html";
}

let textureImg = new Image();
textureImg.crossOrigin="anonymous";
textureImg.src = config.texture;

let roomImg = null;
let maskImg = null;

let scaleFactor = 1;
let opacity = 0.85;
let brightness = 1;

const canvas = document.getElementById("roomCanvas");
const ctx = canvas.getContext("2d");

/* ================= CONTROLS ================= */
document.getElementById("tileScale").oninput = e=>{
 scaleFactor = parseFloat(e.target.value);
 render();
};

document.getElementById("tileOpacity").oninput = e=>{
 opacity = parseFloat(e.target.value);
 render();
};

document.getElementById("brightness").oninput = e=>{
 brightness = parseFloat(e.target.value);
 render();
};

/* ================= UPLOAD ROOM ================= */
document.getElementById("roomUpload").addEventListener("change", async (e)=>{

 const file = e.target.files[0];
 if(!file) return;

 const formData = new FormData();
 formData.append("image", file);

 const res = await fetch("/segment-room",{
  method:"POST",
  body: formData
 });

 const data = await res.json();

 roomImg = new Image();
 roomImg.src = URL.createObjectURL(file);

 maskImg = new Image();
 maskImg.src = data.maskUrl;

 await Promise.all([
  new Promise(r=>roomImg.onload=r),
  new Promise(r=>maskImg.onload=r)
 ]);

 canvas.width = roomImg.width;
 canvas.height = roomImg.height;

 localStorage.setItem("lastRoomImage", roomImg.src);
 localStorage.setItem("lastMaskImage", data.maskUrl);

 render();
});

/* ================= RESTORE SESSION ================= */
function restoreSession(){
 const savedRoom = localStorage.getItem("lastRoomImage");
 const savedMask = localStorage.getItem("lastMaskImage");

 if(savedRoom && savedMask){
  roomImg = new Image();
  maskImg = new Image();

  roomImg.src = savedRoom;
  maskImg.src = savedMask;

  Promise.all([
   new Promise(r=>roomImg.onload=r),
   new Promise(r=>maskImg.onload=r)
  ]).then(()=>{
   canvas.width = roomImg.width;
   canvas.height = roomImg.height;
   render();
  });
 }
}

restoreSession();

/* ================= RENDER ENGINE ================= */
function render(){
 if(!roomImg || !maskImg || !textureImg.complete) return;

 ctx.clearRect(0,0,canvas.width,canvas.height);

 // Draw room
 ctx.filter = `brightness(${brightness})`;
 ctx.drawImage(roomImg,0,0);
 ctx.filter = "none";

 // Create scaled pattern
 const tempCanvas = document.createElement("canvas");
 tempCanvas.width = textureImg.width * scaleFactor;
 tempCanvas.height = textureImg.height * scaleFactor;

 const tctx = tempCanvas.getContext("2d");
 tctx.drawImage(textureImg,0,0,tempCanvas.width,tempCanvas.height);

 const pattern = ctx.createPattern(tempCanvas,"repeat");

 // Apply mask
 ctx.save();
 ctx.globalAlpha = opacity;
 ctx.globalCompositeOperation = "multiply";

 ctx.drawImage(maskImg,0,0);

 ctx.fillStyle = pattern;
 ctx.fillRect(0,0,canvas.width,canvas.height);

 ctx.restore();
}

/* ================= SAVE PROJECT ================= */
async function saveProject(){

 const user = JSON.parse(localStorage.getItem("user"));
 if(!user){alert("Login required");return;}

 const response = await fetch("/save-room-project",{
  method:"POST",
  headers:{"Content-Type":"application/json"},
  body:JSON.stringify({
   userId:user.id,
   config,
   roomImage: localStorage.getItem("lastRoomImage"),
   maskImage: localStorage.getItem("lastMaskImage")
  })
 });

 const data = await response.json();
 if(data.success) alert("Project saved!");
}

/* ================= NAV ================= */
function goBack(){
 window.location.href="configurator.html";
}

</script>
</body>
</html>