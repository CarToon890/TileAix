<!DOCTYPE html>
<html>
<head>
    <title>Room Preview - TileAI</title>
    <style>
        body { font-family: sans-serif; background: #f3f3f3; text-align: center; padding: 40px; }
        .preview-container { 
            background: white; padding: 20px; border-radius: 15px; 
            display: inline-block; box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
        }
        canvas, #myImage { border-radius: 10px; max-width: 100%; height: auto; background: #eee; }
        #myImage { display: none; margin: 0 auto; } /* ‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ‡∏£‡∏≠ AI */
        .controls { margin-top: 20px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
        .btn { padding: 10px 25px; border-radius: 20px; border: none; cursor: pointer; text-decoration: none; font-size: 14px; }
        .btn-back { background: #eee; color: #333; }
        .btn-save { background: #1f4f8b; color: white; }
        .btn-ai { background: #28a745; color: white; font-weight: bold; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
    </style>
</head>
<body>

    <h1>Virtual Room Preview</h1>
    <p>‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏π‡∏Å‡∏£‡∏∞‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏•‡∏á‡∏ö‡∏ô‡∏´‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>

    <div class="preview-container">
        <canvas id="previewCanvas" width="800" height="500"></canvas>
        
        <img id="myImage" width="800" height="500">
        
        <div class="controls">
            <a href="generator.html" class="btn btn-back">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÅ‡∏Å‡πâ‡∏•‡∏≤‡∏¢</a>
            
            <button id="aiBtn" onclick="renderWithAI()" class="btn btn-ai">ü™Ñ ‡∏õ‡∏π‡∏û‡∏∑‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ AI (AI Smart Render)</button>
            
            <button onclick="downloadImage()" class="btn btn-save">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('previewCanvas');
        const ctx = canvas.getContext('2d');
        const myImage = document.getElementById('myImage');

        const roomSrc = localStorage.getItem('roomImage');
        const tileSrc = localStorage.getItem('lastTexture');

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏≤‡∏î Canvas ‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô
        async function renderPreview() {
            if (!roomSrc || !tileSrc) {
                alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏π‡∏õ‡∏´‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏≤‡∏¢‡∏Å‡∏£‡∏∞‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á");
                return;
            }

            const roomImg = new Image();
            roomImg.crossOrigin = "anonymous";
            roomImg.src = window.location.origin + roomSrc;

            roomImg.onload = () => {
                ctx.drawImage(roomImg, 0, 0, 800, 500);

                const tileImg = new Image();
                tileImg.crossOrigin = "anonymous";
                tileImg.src = tileSrc.startsWith('http') ? tileSrc : window.location.origin + tileSrc;

                tileImg.onload = () => {
                    ctx.save();
                    ctx.globalAlpha = 0.5; // ‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏à‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏´‡πâ‡∏≠‡∏á
                    const pattern = ctx.createPattern(tileImg, 'repeat');
                    ctx.fillStyle = pattern;
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.restore();
                };
            };
        }

        renderPreview();

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏Å AI
        async function renderWithAI() {
            const aiBtn = document.getElementById('aiBtn');
            
            aiBtn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...";
            aiBtn.disabled = true;

            try {
                const response = await fetch("/api/ai-preview", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        roomImageUrl: roomSrc,
                        tileImageUrl: tileSrc
                    })
                });

                const data = await response.json();
                
                if (data.finalImage) {
                    canvas.style.display = 'none';
                    myImage.src = data.finalImage;
                    myImage.style.display = 'block';
                } else {
                    alert("AI ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ API");
                }
            } catch (err) {
                console.error(err);
                alert("AI ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Server ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì");
            } finally {
                aiBtn.innerText = "ü™Ñ ‡∏õ‡∏π‡∏û‡∏∑‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ AI (AI Smart Render)";
                aiBtn.disabled = false;
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ
        function downloadImage() {
            const link = document.createElement('a');
            link.download = 'tile-design-preview.png';
            
            // ‡∏ñ‡πâ‡∏≤ AI ‡πÇ‡∏ä‡∏ß‡πå‡∏£‡∏π‡∏õ‡∏≠‡∏¢‡∏π‡πà ‡πÉ‡∏´‡πâ‡πÄ‡∏ã‡∏ü‡∏£‡∏π‡∏õ AI ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà ‡∏°‡∏µ‡πÉ‡∏´‡πâ‡πÄ‡∏ã‡∏ü Canvas
            if (myImage.style.display === 'block') {
                link.href = myImage.src;
            } else {
                link.href = canvas.toDataURL("image/png");
            }
            link.click();
        }
    </script>
</body>
</html>