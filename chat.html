<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤ AI ‚Äî TileAI</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{
  --cream:#f5f0e8;--stone:#2c2825;--terracotta:#c4623a;
  --gold:#d4a853;--sand:#e8d5b0;--warm-gray:#8c7f74;
}
html,body{height:100%;font-family:'DM Sans',sans-serif;background:var(--cream);color:var(--stone);}

nav{
  display:flex;justify-content:space-between;align-items:center;
  padding:20px 50px;background:var(--stone);
}
.logo{font-family:'Playfair Display',serif;font-size:22px;color:var(--cream);}
.nav-links{display:flex;gap:30px;}
.nav-links a{color:var(--sand);font-size:13px;text-decoration:none;transition:.2s;}
.nav-links a:hover{color:var(--gold);}

.progress-bar{display:flex;background:var(--stone);}
.prog-step{
  flex:1;padding:14px 0;text-align:center;
  font-size:11px;letter-spacing:1px;color:var(--warm-gray);text-transform:uppercase;position:relative;
}
.prog-step.done{color:var(--sand);}
.prog-step.done::after{content:'';position:absolute;bottom:0;left:0;right:0;height:2px;background:rgba(255,255,255,.2);}
.prog-step.active{color:var(--gold);}
.prog-step.active::after{content:'';position:absolute;bottom:0;left:0;right:0;height:2px;background:var(--gold);}

/* CHAT LAYOUT */
.chat-wrap{
  display:grid;
  grid-template-columns:300px 1fr;
  height:calc(100vh - 120px);
}

/* SIDEBAR */
.sidebar{
  background:var(--stone);
  display:flex;flex-direction:column;
  border-right:1px solid rgba(255,255,255,.08);
}
.sidebar-header{
  padding:28px 24px 20px;
  border-bottom:1px solid rgba(255,255,255,.08);
}
.sidebar-header h2{
  font-family:'Playfair Display',serif;
  color:var(--cream);font-size:20px;margin-bottom:6px;
}
.sidebar-header p{color:var(--warm-gray);font-size:13px;line-height:1.5;}

/* TILE PREVIEW IN SIDEBAR */
.tile-preview-box{
  padding:20px 24px;border-bottom:1px solid rgba(255,255,255,.08);
}
.tile-preview-label{color:var(--warm-gray);font-size:11px;letter-spacing:1px;text-transform:uppercase;margin-bottom:10px;}
.tile-preview-img{
  width:100%;border-radius:8px;aspect-ratio:1;
  object-fit:cover;background:#1a1714;
  display:flex;align-items:center;justify-content:center;
  color:var(--warm-gray);font-size:12px;
}
canvas.mini-canvas{width:100%;border-radius:8px;display:block;}
.tile-meta{margin-top:10px;}
.tile-meta-row{display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px solid rgba(255,255,255,.05);}
.tile-meta-row:last-child{border:none;}
.tm-label{color:var(--warm-gray);font-size:11px;}
.tm-val{color:var(--sand);font-size:11px;}

/* QUICK QUESTIONS */
.quick-section{padding:20px 24px;flex:1;overflow-y:auto;}
.quick-label{color:var(--warm-gray);font-size:11px;letter-spacing:1px;text-transform:uppercase;margin-bottom:12px;}
.quick-btn{
  display:block;width:100%;text-align:left;
  padding:10px 12px;margin-bottom:8px;
  background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);
  border-radius:8px;cursor:pointer;color:var(--sand);font-size:12px;
  font-family:'DM Sans',sans-serif;transition:.2s;line-height:1.4;
}
.quick-btn:hover{background:rgba(196,98,58,.2);border-color:var(--terracotta);}

/* MAIN CHAT */
.chat-main{
  display:flex;flex-direction:column;background:var(--cream);
}

/* MESSAGES */
.messages{
  flex:1;overflow-y:auto;padding:30px 40px;
  display:flex;flex-direction:column;gap:20px;
}

.msg{display:flex;gap:12px;animation:fadeUp .3s ease;}
@keyframes fadeUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

.msg.user{flex-direction:row-reverse;}

.avatar{
  width:36px;height:36px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  font-size:16px;flex-shrink:0;
}
.avatar.ai{background:var(--terracotta);}
.avatar.user{background:var(--stone);}

.bubble{
  max-width:70%;padding:14px 18px;border-radius:16px;
  font-size:14px;line-height:1.7;
}
.bubble.ai{
  background:white;border:1px solid #e5e0d8;
  border-bottom-left-radius:4px;
  box-shadow:0 2px 8px rgba(0,0,0,.05);
}
.bubble.user{
  background:var(--stone);color:var(--sand);
  border-bottom-right-radius:4px;
}

.typing-indicator{
  display:flex;gap:4px;padding:16px 18px;
  background:white;border:1px solid #e5e0d8;border-radius:16px;border-bottom-left-radius:4px;
  width:fit-content;
}
.dot{
  width:8px;height:8px;background:var(--warm-gray);border-radius:50%;
  animation:bounce 1.2s infinite;
}
.dot:nth-child(2){animation-delay:.2s}
.dot:nth-child(3){animation-delay:.4s}
@keyframes bounce{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-6px)}}

/* INPUT ROW */
.input-row{
  padding:20px 40px;background:white;border-top:1px solid #e5e0d8;
  display:flex;gap:12px;
}
textarea#chatInput{
  flex:1;padding:14px 18px;
  border:1.5px solid #ddd;border-radius:12px;
  font-family:'DM Sans',sans-serif;font-size:14px;color:var(--stone);
  resize:none;height:50px;max-height:120px;outline:none;
  transition:.2s;line-height:1.5;overflow:hidden;
}
textarea#chatInput:focus{border-color:var(--terracotta);}
.btn-send{
  width:50px;height:50px;border-radius:12px;
  background:var(--terracotta);border:none;cursor:pointer;
  color:white;font-size:20px;transition:.2s;flex-shrink:0;
}
.btn-send:hover{background:#b5572f;}
.btn-send:disabled{background:#ccc;cursor:not-allowed;}

/* WELCOME */
.welcome-msg{
  background:linear-gradient(135deg,#fdf5f0,#f5ece0);
  border:1px solid #e8d5c0;border-radius:16px;
  padding:24px;margin-bottom:4px;
}
.welcome-msg h3{font-family:'Playfair Display',serif;font-size:18px;margin-bottom:8px;}
.welcome-msg p{font-size:13px;color:var(--warm-gray);line-height:1.6;}

@media(max-width:900px){
  .chat-wrap{grid-template-columns:1fr;}
  .sidebar{display:none;}
  nav{padding:16px 20px;}
  .messages{padding:20px;}
  .input-row{padding:16px 20px;}
}
</style>
</head>
<body>

<nav>
  <div class="logo">‚ú¶ TileAI</div>
  <div class="nav-links">
    <a href="tile-form.html">‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö</a>
    <a href="room-view.html">‡∏î‡∏π‡∏´‡πâ‡∏≠‡∏á</a>
    <a href="chat.html">‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤ AI</a>
  </div>
</nav>

<div class="progress-bar">
  <div class="prog-step done">1 ¬∑ ‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö</div>
  <div class="prog-step done">2 ¬∑ ‡∏î‡∏π‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á</div>
  <div class="prog-step active">3 ¬∑ ‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤ AI</div>
</div>

<div class="chat-wrap">

  <!-- SIDEBAR -->
  <div class="sidebar">
    <div class="sidebar-header">
      <h2>‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤ AI</h2>
      <p>‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Å‡∏£‡∏∞‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á ‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡∏≠‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢</p>
    </div>

    <div class="tile-preview-box">
      <div class="tile-preview-label">‡∏Å‡∏£‡∏∞‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</div>
      <canvas class="mini-canvas" id="miniCanvas" width="252" height="120"></canvas>
      <div class="tile-meta" id="tileMeta"></div>
    </div>

    <div class="quick-section">
      <div class="quick-label">‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°</div>
      <button class="quick-btn" onclick="askQuick(this)">‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö‡∏´‡πâ‡∏≠‡∏á‡∏ô‡πâ‡∏≥‡πÑ‡∏´‡∏°?</button>
      <button class="quick-btn" onclick="askQuick(this)">‡∏Ñ‡∏ß‡∏£‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏ß‡∏Å‡∏£‡∏∞‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ä‡∏ô‡∏¥‡∏î‡πÑ‡∏´‡∏ô?</button>
      <button class="quick-btn" onclick="askQuick(this)">‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏£‡∏≠‡∏¢‡∏ï‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà?</button>
      <button class="quick-btn" onclick="askQuick(this)">‡∏ß‡∏¥‡∏ò‡∏µ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Å‡∏£‡∏∞‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á</button>
      <button class="quick-btn" onclick="askQuick(this)">‡∏ï‡πâ‡∏≠‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏Å‡∏£‡∏∞‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏µ‡πà‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏™‡∏≥‡∏£‡∏≠‡∏á?</button>
      <button class="quick-btn" onclick="askQuick(this)">‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏™‡∏µ‡∏ã‡∏≤‡πÅ‡∏ô‡∏ß‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ö‡∏Å‡∏£‡∏∞‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ</button>
      <button class="quick-btn" onclick="askQuick(this)">‡∏Å‡∏£‡∏∞‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ä‡∏ô‡∏¥‡∏î‡∏ô‡∏µ‡πâ‡∏Å‡∏±‡∏ô‡∏•‡∏∑‡πà‡∏ô‡πÑ‡∏´‡∏°?</button>
    </div>
  </div>

  <!-- CHAT MAIN -->
  <div class="chat-main">
    <div class="messages" id="messages">
      <div class="welcome-msg">
        <h3>‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö! üëã</h3>
        <p>‡∏ú‡∏°‡∏Ñ‡∏∑‡∏≠ TileAI ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏£‡∏∞‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏´‡πâ‡∏≠‡∏á ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ñ‡∏≤‡∏°‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏£‡∏∞‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á ‡∏ß‡∏±‡∏™‡∏î‡∏∏ ‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö</p>
      </div>
      <div class="msg ai">
        <div class="avatar ai">‚ú¶</div>
        <div class="bubble ai" id="welcomeBubble">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏£‡∏∞‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì...</div>
      </div>
    </div>

    <div class="input-row">
      <textarea id="chatInput" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..." onkeydown="handleKey(event)" oninput="autoResize(this)"></textarea>
      <button class="btn-send" id="btnSend" onclick="sendMsg()">‚û§</button>
    </div>
  </div>

</div>

<script>
/* AUTH */
const user = JSON.parse(localStorage.getItem("user") || "null");
if(!user){ window.location.href="login.html"; }

/* TILE CONFIG */
const cfg = JSON.parse(localStorage.getItem("tileConfig") || "{}");
const tileUrl = localStorage.getItem("tileUrl");

/* MINI CANVAS */
if(tileUrl){
  const miniCanvas = document.getElementById("miniCanvas");
  const mctx = miniCanvas.getContext("2d");
  const img = new Image();
  img.crossOrigin="anonymous";
  img.onload=()=>{
    const tpx=60, gw=3;
    mctx.clearRect(0,0,252,120);
    for(let y=0;y<120;y+=tpx+gw)
      for(let x=0;x<252;x+=tpx+gw){
        mctx.drawImage(img,x,y,tpx,tpx);
        mctx.fillStyle="#ddd";
        mctx.fillRect(x+tpx,y,gw,tpx);
        mctx.fillRect(x,y+tpx,tpx+gw,gw);
      }
  };
  img.src=tileUrl;
}

/* TILE META */
const metaEl=document.getElementById("tileMeta");
if(cfg.material){
  metaEl.innerHTML=[
    ["‡∏ß‡∏±‡∏™‡∏î‡∏∏",cfg.material],["‡∏™‡∏µ",cfg.color],
    ["‡∏Ç‡∏ô‡∏≤‡∏î",cfg.size+"‡∏ã‡∏°."],["‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà",cfg.area+"‡∏ï‡∏£.‡∏°."]
  ].map(([l,v])=>`<div class="tile-meta-row"><span class="tm-label">${l}</span><span class="tm-val">${v||"-"}</span></div>`).join("");
}

/* SYSTEM PROMPT */
function buildSystemPrompt(){
  let base = `‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏£‡∏∞‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢ ‡∏ä‡∏∑‡πà‡∏≠ TileAI ‡∏ï‡∏≠‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡πÄ‡∏™‡∏°‡∏≠ ‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏©‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏¥‡∏ï‡∏£ ‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö ‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡∏´‡πâ‡∏≤‡∏°‡∏ï‡∏≠‡∏ö‡∏ô‡∏≠‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Å‡∏£‡∏∞‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á ‡∏ß‡∏±‡∏™‡∏î‡∏∏ ‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏´‡πâ‡∏≠‡∏á ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á`;
  if(cfg.material) base += `\n\n‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏£‡∏∞‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ: ‡∏ß‡∏±‡∏™‡∏î‡∏∏=${cfg.material}, ‡∏™‡∏µ=${cfg.color||"-"}, ‡∏•‡∏≤‡∏¢=${cfg.pattern||"-"}, ‡∏Ç‡∏ô‡∏≤‡∏î=${cfg.size||"-"}‡∏ã‡∏°., ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà=${cfg.area||"-"}‡∏ï‡∏£.‡∏°. ‡πÉ‡∏´‡πâ‡∏ï‡∏≠‡∏ö‡πÇ‡∏î‡∏¢‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á`;
  return base;
}

/* CHAT HISTORY */
let history = [];

/* WELCOME MESSAGE */
async function sendWelcome(){
  const welcomeQ = cfg.material
    ? `‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏£‡∏∞‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á${cfg.material}‡πÇ‡∏ó‡∏ô${cfg.color||""}‡∏Ç‡∏ô‡∏≤‡∏î${cfg.size||""}‡∏ã‡∏°. ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà${cfg.area||""}‡∏ï‡∏£.‡∏°. ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡∏™‡∏±‡πâ‡∏ô‡πÜ 2-3 ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ`
    : "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ß‡πà‡∏≤‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ñ‡∏≤‡∏°‡∏≠‡∏∞‡πÑ‡∏£‡πÑ‡∏î‡πâ‡∏ö‡πâ‡∏≤‡∏á";

  history.push({role:"user",content:welcomeQ});
  const res = await callAI(history);
  document.getElementById("welcomeBubble").textContent = res;
  history.push({role:"assistant",content:res});
}
sendWelcome();

/* SEND */
async function sendMsg(){
  const input = document.getElementById("chatInput");
  const text = input.value.trim();
  if(!text) return;

  input.value=""; input.style.height="50px";
  document.getElementById("btnSend").disabled=true;

  addMsg("user", text);
  history.push({role:"user",content:text});

  /* typing */
  const typingId = addTyping();

  const res = await callAI(history);
  removeTyping(typingId);

  addMsg("ai", res);
  history.push({role:"assistant",content:res});
  document.getElementById("btnSend").disabled=false;
}

function askQuick(btn){
  document.getElementById("chatInput").value = btn.textContent;
  sendMsg();
}

/* ADD MESSAGE */
function addMsg(role, text){
  const msgs = document.getElementById("messages");
  const div = document.createElement("div");
  div.className = "msg "+role;
  div.innerHTML = `
    <div class="avatar ${role}">${role==="ai"?"‚ú¶":"üë§"}</div>
    <div class="bubble ${role}">${text.replace(/\n/g,"<br>")}</div>
  `;
  msgs.appendChild(div);
  msgs.scrollTop = msgs.scrollHeight;
}

function addTyping(){
  const msgs = document.getElementById("messages");
  const id = "typing-"+Date.now();
  const div = document.createElement("div");
  div.className="msg ai"; div.id=id;
  div.innerHTML=`<div class="avatar ai">‚ú¶</div><div class="typing-indicator"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>`;
  msgs.appendChild(div);
  msgs.scrollTop=msgs.scrollHeight;
  return id;
}

function removeTyping(id){
  const el=document.getElementById(id);
  if(el) el.remove();
}

/* CALL AI */
async function callAI(msgs){
  try{
    const res = await fetch("/api/chat",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({
        messages: msgs,
        system: buildSystemPrompt(),
        userId: user.id
      })
    });
    const data = await res.json();
    return data.reply || "‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢ ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á";
  }catch{
    return "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á";
  }
}

/* KEYBOARD */
function handleKey(e){
  if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); sendMsg(); }
}
function autoResize(el){
  el.style.height="50px";
  el.style.height=Math.min(el.scrollHeight,120)+"px";
}
</script>
</body>
</html>
